import osimport reimport pandas as pdimport pyvoimport requestsfrom tqdm import tqdmfrom astropy.table import Tablefrom io import BytesIOfrom urllib.parse import urlparsecsv_file = "ASTR502_Mega_Target_List.csv"outdir = "data/raw/ESO"os.makedirs(outdir, exist_ok=True)max_targets = 3max_files_per_target = 10radius_arcmin = 5timeout_sec = 25tap = pyvo.dal.TAPService("https://archive.eso.org/tap_obs")df = pd.read_csv(csv_file).head(max_targets)def clean(s):    return re.sub(r"[^A-Za-z0-9._-]+", "_", str(s))def dl_table(datalink_url):    r = requests.get(datalink_url, timeout=timeout_sec)    r.raise_for_status()    return Table.read(BytesIO(r.content), format="votable")def pick_main_urls(t):    if "access_url" not in t.colnames:        return []    if "semantics" in t.colnames:        urls = [str(t["access_url"][i]) for i in range(len(t)) if t["access_url"][i] is not None and "#this" in str(t["semantics"][i])]        if urls:            return urls    urls = [str(u) for u in t["access_url"] if u is not None]    fitsy = [u for u in urls if "fits" in u.lower()]    return fitsy if fitsy else urls[:1]def download(url, path):    if os.path.exists(path) and os.path.getsize(path) > 0:        return False    r = requests.get(url, stream=True, timeout=120)    r.raise_for_status()    with open(path, "wb") as f:        for chunk in r.iter_content(1024 * 1024):            if chunk:                f.write(chunk)    return Trueinst_like = ["%HARPS%", "%UVES%", "%ESPRESSO%", "%FEROS%"]inst_clause = " OR ".join([f"instrument_name LIKE '{s}'" for s in inst_like])radius_deg = radius_arcmin / 60.0for _, row in df.iterrows():    name = clean(row.get("pl_name", row.get("hostname", "target")))    ra = float(row["ra"])    dec = float(row["dec"])    target_dir = os.path.join(outdir, name)    os.makedirs(target_dir, exist_ok=True)    adql = f"""    SELECT TOP 200 instrument_name, access_url, access_format    FROM ivoa.ObsCore    WHERE dataproduct_type='spectrum'      AND 1=CONTAINS(POINT('ICRS', s_ra, s_dec), CIRCLE('ICRS', {ra}, {dec}, {radius_deg}))      AND ({inst_clause})    """    res = tap.search(adql).to_table()    print(f"\n{name}: {len(res)} ESO spectra rows")    if len(res) == 0:        continue    got = 0    for dl in tqdm(list(res["access_url"]), total=len(res)):        if got >= max_files_per_target:            break        try:            t = dl_table(str(dl))            urls = pick_main_urls(t)        except Exception:            continue        for u in urls:            if got >= max_files_per_target:                break            fn = os.path.basename(urlparse(u).path) or clean(u)            path = os.path.join(target_dir, fn)            try:                if download(u, path):                    got += 1            except Exception:                continue    print(f"{name}: downloaded {got} file(s)")